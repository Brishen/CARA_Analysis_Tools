"""Example validation case for the Pc3D_Hall implementation.

This is a direct Python port of:
`DistributedMatlab/ProbabilityOfCollision/Pc3D_Hall_Utils/Pc3D_Hall_Example1.m`.

Running this module prints:

    Pc2D = 1.0281653e-02
    Pc3D = 1.0281834e-02

(with small floating-point differences possible across platforms).
"""

import numpy as np

from DistributedPython.ProbabilityOfCollision.Pc3D_Hall import Pc3D_Hall
from DistributedPython.ProbabilityOfCollision.PcElrod import PcElrod


def Pc3D_Hall_Example1():
    """Run Hall example #1 and return 2D/3D probability-of-collision values."""

    r1 = np.array([
        -9.841950433215101e05,
        +3.932342044549424e05,
        +6.991223682230414e06,
    ])
    v1 = np.array([
        +4.883696742000000e03,
        +5.689086045000000e03,
        +3.665361590000000e02,
    ])
    cov1 = np.array([
        [+4.976545641899520e04, +5.787130862568278e04, +3.370410320935015e03, +1.137272273949272e01, -4.325472616114674e00, -8.009705480233521e01],
        [+5.787130862568278e04, +6.730377643610841e04, +3.926542932121541e03, +1.321992688238858e01, -5.035560720747812e00, -9.314985106902773e01],
        [+3.370410320935015e03, +3.926542932121541e03, +2.461403197221289e02, +7.586865834476763e-01, -3.077848629905763e-01, -5.434034460756914e00],
        [+1.137272273949272e01, +1.321992688238858e01, +7.586865834476763e-01, +2.608186227148725e-03, -9.804181796720670e-04, -1.829751672999786e-02],
        [-4.325472616114674e00, -5.035560720747812e00, -3.077848629905763e-01, -9.804181796720670e-04, +3.895883508545853e-04, +6.968892326415779e-03],
        [-8.009705480233521e01, -9.314985106902773e01, -5.434034460756914e00, -1.829751672999786e-02, +6.968892326415779e-03, +1.289253320300791e-01],
    ])

    r2 = np.array([
        -9.839696058965517e05,
        +3.936845951174244e05,
        +6.991219291625473e06,
    ])
    v2 = np.array([
        +1.509562687000000e03,
        +7.372938617000000e03,
        -1.492509430000000e02,
    ])
    cov2 = np.array([
        [+4.246862551076427e04, +2.066374367781032e05, -5.011108933888592e03, +3.104606531932427e01, -1.201093683199582e01, -2.207975848324051e02],
        [+2.066374367781032e05, +1.005854717283451e06, -2.434876491048039e04, +1.510022508670080e02, -5.850063541467530e01, -1.074752763805685e03],
        [-5.011108933888592e03, -2.434876491048039e04, +6.131274993037449e02, -3.667147183233717e00, +1.391769957262238e00, +2.601457791444154e01],
        [+3.104606531932427e01, +1.510022508670080e02, -3.667147183233717e00, +2.272826228568773e-02, -8.778253314778023e-03, -1.613538091053610e-01],
        [-1.201093683199582e01, -5.850063541467530e01, +1.391769957262238e00, -8.778253314778023e-03, +3.428801115804722e-03, +6.251148178133809e-02],
        [-2.207975848324051e02, -1.074752763805685e03, +2.601457791444154e01, -1.613538091053610e-01, +6.251148178133809e-02, +1.148404222181769e00],
    ])

    hbr = 20.0

    pc2d, _, _, _ = PcElrod(r1.reshape(1, 3), v1.reshape(1, 3), cov1,
                            r2.reshape(1, 3), v2.reshape(1, 3), cov2, hbr)
    pc3d, _ = Pc3D_Hall(r1, v1, cov1, r2, v2, cov2, hbr, params={'Texpand': 1.0})

    pc2d_raw = np.asarray(pc2d).reshape(-1)[0]
    pc2d_scalar = float(np.real_if_close(pc2d_raw, tol=1000).real)

    print(f"Pc2D = {pc2d_scalar:0.7e}")
    print(f"Pc3D = {pc3d:0.7e}")

    return pc2d_scalar, pc3d


if __name__ == "__main__":
    Pc3D_Hall_Example1()
