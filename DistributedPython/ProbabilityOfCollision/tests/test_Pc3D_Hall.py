import unittest
import numpy as np
from DistributedPython.ProbabilityOfCollision.Pc3D_Hall import Pc3D_Hall

class TestPc3D_Hall(unittest.TestCase):

    def test_bad_covariance(self):
        # Original Test Omitron Test Case 01 (Written by Dragan Plakalovic)
        r1 = np.array([378.39559, 4305.721887, 5752.767554]) * 1000
        v1 = np.array([2.360800244, 5.580331936, -4.322349039]) * 1000
        r2 = np.array([374.5180598, 4307.560983, 5751.130418]) * 1000
        v2 = np.array([-5.388125081, -3.946827739, 3.322820358]) * 1000

        # 3x3 covariances (should fail)
        cov1 = np.array([
            [44.5757544811362, 81.6751751052616, -67.8687662707124],
            [81.6751751052616, 158.453402956163, -128.616921644857],
            [-67.8687662707124, -128.616921644858, 105.490542562701]
        ]) * 1e6

        cov2 = np.array([
            [2.31067077720423, 1.69905293875632, -1.4170164577661],
            [1.69905293875632, 1.24957388457206, -1.04174164279599],
            [-1.4170164577661, -1.04174164279599, 0.869260558223714]
        ]) * 1e6

        HBR = 20

        with self.assertRaisesRegex(ValueError, 'Pc3D_Hall:badCovariance'):
            Pc3D_Hall(r1, v1, cov1, r2, v2, cov2, HBR)

    def test_similar_to_2d(self):
        # Returns a value very similar to PcElrod
        expSolution = 1.0289973e-02
        Accuracy = 0.001

        r1 = np.array([-9.841950433215101e+05, +3.932342044549424e+05, +6.991223682230414e+06])
        v1 = np.array([+4.883696742000000e+03, +5.689086045000000e+03, +3.665361590000000e+02])

        cov1 = np.array([
            [+4.976545641899520e+04, +5.787130862568278e+04, +3.370410320935015e+03, +1.137272273949272e+01, -4.325472616114674e+00, -8.009705480233521e+01],
            [+5.787130862568278e+04, +6.730377643610841e+04, +3.926542932121541e+03, +1.321992688238858e+01, -5.035560720747812e+00, -9.314985106902773e+01],
            [+3.370410320935015e+03, +3.926542932121541e+03, +2.461403197221289e+02, +7.586865834476763e-01, -3.077848629905763e-01, -5.434034460756914e+00],
            [+1.137272273949272e+01, +1.321992688238858e+01, +7.586865834476763e-01, +2.608186227148725e-03, -9.804181796720670e-04, -1.829751672999786e-02],
            [-4.325472616114674e+00, -5.035560720747812e+00, -3.077848629905763e-01, -9.804181796720670e-04, +3.895883508545853e-04, +6.968892326415779e-03],
            [-8.009705480233521e+01, -9.314985106902773e+01, -5.434034460756914e+00, -1.829751672999786e-02, +6.968892326415779e-03, +1.289253320300791e-01]
        ])

        r2 = np.array([-9.839696058965517e+05, +3.936845951174244e+05, +6.991219291625473e+06])
        v2 = np.array([+1.509562687000000e+03, +7.372938617000000e+03, -1.492509430000000e+02])

        cov2 = np.array([
            [+4.246862551076427e+04, +2.066374367781032e+05, -5.011108933888592e+03, +3.104606531932427e+01, -1.201093683199582e+01, -2.207975848324051e+02],
            [+2.066374367781032e+05, +1.005854717283451e+06, -2.434876491048039e+04, +1.510022508670080e+02, -5.850063541467530e+01, -1.074752763805685e+03],
            [-5.011108933888592e+03, -2.434876491048039e+04, +6.131274993037449e+02, -3.667147183233717e+00, +1.391769957262238e+00, +2.601457791444154e+01],
            [+3.104606531932427e+01, +1.510022508670080e+02, -3.667147183233717e+00, +2.272826228568773e-02, -8.778253314778023e-03, -1.613538091053610e-01],
            [-1.201093683199582e+01, -5.850063541467530e+01, +1.391769957262238e+00, -8.778253314778023e-03, +3.428801115804722e-03, +6.251148178133809e-02],
            [-2.207975848324051e+02, -1.074752763805685e+03, +2.601457791444154e+01, -1.613538091053610e-01, +6.251148178133809e-02, +1.148404222181769e+00]
        ])

        HBR = 20

        Pc, out = Pc3D_Hall(r1, v1, cov1, r2, v2, cov2, HBR)

        print(f"Computed Pc: {Pc}, Expected: {expSolution}")
        self.assertTrue(np.isclose(Pc, expSolution, rtol=Accuracy))


    def test_texpand_scalar_executes(self):
        r1 = np.array([-9.841950433215101e+05, +3.932342044549424e+05, +6.991223682230414e+06])
        v1 = np.array([+4.883696742000000e+03, +5.689086045000000e+03, +3.665361590000000e+02])
        cov1 = np.array([
            [+4.976545641899520e+04, +5.787130862568278e+04, +3.370410320935015e+03, +1.137272273949272e+01, -4.325472616114674e+00, -8.009705480233521e+01],
            [+5.787130862568278e+04, +6.730377643610841e+04, +3.926542932121541e+03, +1.321992688238858e+01, -5.035560720747812e+00, -9.314985106902773e+01],
            [+3.370410320935015e+03, +3.926542932121541e+03, +2.461403197221289e+02, +7.586865834476763e-01, -3.077848629905763e-01, -5.434034460756914e+00],
            [+1.137272273949272e+01, +1.321992688238858e+01, +7.586865834476763e-01, +2.608186227148725e-03, -9.804181796720670e-04, -1.829751672999786e-02],
            [-4.325472616114674e+00, -5.035560720747812e+00, -3.077848629905763e-01, -9.804181796720670e-04, +3.895883508545853e-04, +6.968892326415779e-03],
            [-8.009705480233521e+01, -9.314985106902773e+01, -5.434034460756914e+00, -1.829751672999786e-02, +6.968892326415779e-03, +1.289253320300791e-01]
        ])
        r2 = np.array([-9.839696058965517e+05, +3.936845951174244e+05, +6.991219291625473e+06])
        v2 = np.array([+1.509562687000000e+03, +7.372938617000000e+03, -1.492509430000000e+02])
        cov2 = np.array([
            [+4.246862551076427e+04, +2.066374367781032e+05, -5.011108933888592e+03, +3.104606531932427e+01, -1.201093683199582e+01, -2.207975848324051e+02],
            [+2.066374367781032e+05, +1.005854717283451e+06, -2.434876491048039e+04, +1.510022508670080e+02, -5.850063541467530e+01, -1.074752763805685e+03],
            [-5.011108933888592e+03, -2.434876491048039e+04, +6.131274993037449e+02, -3.667147183233717e+00, +1.391769957262238e+00, +2.601457791444154e+01],
            [+3.104606531932427e+01, +1.510022508670080e+02, -3.667147183233717e+00, +2.272826228568773e-02, -8.778253314778023e-03, -1.613538091053610e-01],
            [-1.201093683199582e+01, -5.850063541467530e+01, +1.391769957262238e+00, -8.778253314778023e-03, +3.428801115804722e-03, +6.251148178133809e-02],
            [-2.207975848324051e+02, -1.074752763805685e+03, +2.601457791444154e+01, -1.613538091053610e-01, +6.251148178133809e-02, +1.148404222181769e+00]
        ])

        Pc, out = Pc3D_Hall(r1, v1, cov1, r2, v2, cov2, 20, {'Texpand': 1.0})

        self.assertTrue(out['converged'])
        self.assertTrue(np.isclose(Pc, 1.0281834e-02, rtol=1e-6))

if __name__ == '__main__':
    unittest.main()
